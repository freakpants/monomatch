<!DOCTYPE html>
<html>



<head>
    <script src="phaser/dist/phaser.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Oswald|Roboto|Luckiest Guy" rel="stylesheet">
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="controller.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }
    </style>
</head>

<body onload="init()">
    <script>

        var air_console;
        var DEBUG = true;
        document.was_correct = false;

        document.gameScene = "mainmenu";
        document.maxRound = 20;

        $(document).ready(function () {
            $("#confirm").click(function (event) {

                var command = [];
                command.push({ type: "confirm" });
                air_console.message(0, command);
            });
            $("#resume").click(function (event) {
                $(".pause-option").hide();
                $("#pause_button").css("display", "flex");
                var command = [];
                command.push({ type: "resume" });
                air_console.message(0, command);
            });
            $("#options").click(function (event) {
                var command = [];
                command.push({ type: "options" });
                air_console.message(0, command);
                $(".mainmenu-option").hide();
                $(".music-option").css("display", "flex");
            });
            $("#more").click(function (event) {
                if (document.maxRound === 45) {
                    // hide the more button
                    $("#more").hide();
                } else {
                    // show both buttons
                    $("#more").css("display", "flex");
                    $("#less").css("display", "flex");
                }
                document.maxRound += 5;
                var command = [];
                command.push({ type: "more" });
                air_console.message(0, command);
            });
            $("#less").click(function (event) {
                if (document.maxRound === 5) {
                    // hide the less button
                    $("#less").hide();
                } else {
                    // show both buttons
                    $("#more").css("display", "flex");
                    $("#less").css("display", "flex");
                }
                document.maxRound -= 5;
                var command = [];
                command.push({ type: "less" });
                air_console.message(0, command);
            });


            $("#back").click(function (event) {
                var command = [];
                command.push({ type: "back" });
                air_console.message(0, command);

                // show buttons depending on gameScene in a switch
                $(".button").hide();
                switch (document.gameScene) {
                    case "musicoptionsscene":
                        $(".mainmenu-option").css("display", "flex");
                        break;
                    case "roundoptionsscene":
                        $(".music-option").css("display", "flex");
                        break;
                    case "difficultyoptionsscene":
                        $(".round-option").css("display", "flex");
                        break;
                }
            });
            // when the next button is clicked, inform the screen
            $("#next").click(function (event) {
                var command = [];
                command.push({ type: "next" });
                air_console.message(0, command);
                // show buttons depending on gameScene in a switch
                $(".button").hide();
                switch (document.gameScene) {
                    case "musicoptionsscene":
                        // show the round option buttons
                        $(".round-option").css("display", "flex");
                        break;
                    case "roundoptionsscene":
                        // show the difficulty option buttons
                        $(".difficulty-option").css("display", "flex");
                        break;
                }

            });
            $("#music").click(function (event) {
                var command = [];
                command.push({ type: "toggle-music" });
                air_console.message(0, command);
            });
            $("#sfx").click(function (event) {
                var command = [];
                command.push({ type: "toggle-sfx" });
                air_console.message(0, command);
            });
            $("#rotation").click(function (event) {
                var command = [];
                command.push({ type: "toggle-rotation" });
                air_console.message(0, command);
            });
            $("#scaling").click(function (event) {
                var command = [];
                command.push({ type: "toggle-scaling" });
                air_console.message(0, command);
            });
            $("#quit").click(function (event) {
                // get other clients to show waiting for master screen
                game_over_message = [];
                game_over_message.push({ type: "game_over" });
                DEBUG && console.log("sending game over message");
                air_console.broadcast(game_over_message);
                $(".pause-option").hide();
                $(".mainmenu-option").css("display", "flex");
                var command = [];
                command.push({ type: "back_to_main" });
                air_console.message(0, command);
            });
            $("#pause_button").click(function (event) {
                $("#score_and_objects_wrapper").hide();
                $(".button").hide();
                $("#menu").css("display", "flex");
                $("#menu").css("pointer-events", "auto");
                $(".pause-option").css("display", "flex");
                $(".pause-option").css("pointer-events", "auto");
                var command = [];
                command.push({ type: "pause" });
                air_console.broadcast(command);
            });
            $("#game_over").click(function (event) {
                // inform screen to go back to main
                var command = [];
                command.push({ type: "back_to_main" });
                air_console.message(0, command);
                $("#game_over").hide();
                $("#menu").css("display", "flex");
            });
        });

        function am_i_master() {
            return (air_console.getMasterControllerDeviceId() !== undefined && air_console.getMasterControllerDeviceId() === air_console.getDeviceId());
        }

        function show_correct_buttons() {
            // first, hide all buttons
            $(".button").hide();
            // also hide waiting areas
            $("#waiting_for_start").hide();
            $("#waiting_for_pause").hide();
            $("#waiting_for_next_round").hide();
            switch (document.gameScene) {
                case "mainmenu":
                    $(".mainmenu-option").css("display", "flex");
                    break;
                case "musicoptionsscene":
                    $(".music-option").css("display", "flex");
                    break;
                case "pausescreen":
                    $(".pause-option").css("display", "flex");
                    break;
                case "roundoptionsscene":
                    $(".round-option").css("display", "flex");
                    break;
                case "difficultyoptionsscene":
                    $(".difficulty-option").css("display", "flex");
                    break;
                case "guessing":
                    $("#score_and_objects_wrapper").css("display", "flex");
                    $("#score_and_objects_wrapper").css("margin-top", "initial");
                    $("#pause_button").css("display", "flex");
                    break;
            }
        }

        function init() {
            air_console = new AirConsole();

            DEBUG && console.log("airconsole init");

            if(am_i_master()){
                show_correct_buttons();
            }

            // listen for players connecting, that could possible mean we are not master anymore
            air_console.onConnect = function (device_id) {
                DEBUG && console.log("checking if this controller is not master anymore");
                if(am_i_master()){
                    show_correct_buttons();
                } else {
                    $(".button").hide();
                }
                handle_pause_button();
            };

            air_console.onMessage = function (from, data) {

                DEBUG && console.log("received " + data[0].type + " message on controller");
                if (data === undefined || data[0] === undefined || data[0].type === undefined) {
                    return;
                }
                switch (data[0].type) {
                    case "maxRound":
                        document.maxRound = data[0].maxRound;
                        break;
                    case "sceneChange":
                        // save the scene in the document
                        document.gameScene = data[0].scene;
                        if(document.gameScene === "guessing" && $("#objects").children().length === 0){
                            // request icons
                            var command = [];
                            command.push({ type: "request_icons" });
                            air_console.message(0, command);
                        }
                        break;
                    case "resume":
                        $("#score_and_objects_wrapper").css("display", "flex");
                        $("#waiting_for_next_round").hide();
                        $("#waiting_for_pause").hide();
                        break;
                    case "pause":
                        $("#score_and_objects_wrapper").hide();
                        $("#menu").css("display", "flex");
                        $("#waiting_for_start").hide();
                        $("#waiting_for_pause").css("display", "flex");
                        $(".button").hide();
                        break;
                    case "game_over":
                        $("#slow").hide();
                        $("#fast").hide();
                        $("#score_and_objects_wrapper").hide();
                        if (am_i_master()) {
                            $("#game_over").css("display", "flex");
                        } else {
                            $("#menu").css("display", "flex");
                            $("#waiting_for_pause").hide();
                            $("#waiting_for_start").css("display", "flex");
                        }

                        break;
                    case "score":
                        if (data[0].correct !== 1) {
                            // 0 and 2+
                            $("#correct_guesses").html(data[0].correct + " points");
                        } else {
                            // 1
                            $("#correct_guesses").html(data[0].correct + " point");
                        }

                        switch (data[0].position) {
                            case 1:
                                $("#position").html("1st");
                                break;
                            case 2:
                                $("#position").html("2nd");
                                break;
                            case 3:
                                $("#position").html("3rd");
                                break;
                            default:
                                $("#position").html(data[0].position + "th");
                                break;
                        }

                        break;
                    case "countdown_over":
                        $("#slow").hide();
                        $("#fast").hide();
                        $("#score_and_objects_wrapper").css("display", "flex");
                        break;
                    case "correct":
                        $("#score_and_objects_wrapper").hide();
                        $("#round_winner").html(air_console.getNickname(data[0].player));
                        // reset all icons to full opacity
                        $(".object-container img").css("opacity", "1");
                        $("#slow").css("display", "flex");
                        $("#slow").css("opacity", 1);
                        break;
                    case "show_menu":
                    case "hide_menu":
                        if (am_i_master()) {
                            DEBUG && console.log("i am master");
                            $("#waiting_for_start").hide();
                            show_correct_buttons();
                        } else {
                            DEBUG && console.log("i am not master");
                            $("#waiting_for_start").css("display", "flex");
                            $(".button").hide();
                        }
                        break;
                    case "new_screen_set":

                        // get our set
                        const current_set = parseInt($("#objects").attr("data-set-id"));
                        DEBUG && console.log("current set id: " + current_set);
                        change_sets_on_controller(current_set, data[0].screen_set_id, false);

                        break;
                    case "set":
                        DEBUG && console.log("received set info from screen");

                        if (data[0].update) {
                            // if we got an update, don't display the new set just yet
                            $("#score_and_objects_wrapper").hide();
                            $("#fast").css("opacity", 1);
                            $("#fast").css("display", "flex");
                        } else {
                            $("#score_and_objects_wrapper").css("display", "flex");
                        }

                        $("#menu").hide();
                        $("#waiting_for_start").hide();

                        change_sets_on_controller(data[0].set_id, data[0].screen_set_id, true);

                        break;
                }
            }
        }

        function handle_pause_button() {
            if (am_i_master()) {
                $("#score_and_objects_wrapper").css("margin-top", "initial");
                $("#pause_button").css("display", "flex");
                $("#pause_button").css("pointer-events", "auto");
            } else {
                $("#score_and_objects_wrapper").css("margin-top", "10vh");
                $("#pause_button").css("display", "none");
                $("#pause_button").css("pointer-events", "none");
            }
        }

        function change_sets_on_controller(controller_set_id, screen_set_id, first_time) {

            // get our set
            var controller_set = document.projective_sets.filter(obj => {
                return obj.id === controller_set_id;
            })[0];
            DEBUG && console.log(controller_set);
            // get the set our screen has
            var screen_set = document.projective_sets.filter(obj => {
                return obj.id === screen_set_id;
            })[0];
            DEBUG && console.log(screen_set);

            // determine which object is both on screen and on the controller
            // compare our sets
            match_found = false;
            screen_set.icons.forEach(icon_id => {
                if (controller_set.icons.includes(icon_id)) {
                    // check if this is the second match, which would mean we have a faulty set
                    if (match_found) {
                        console.log("faulty set with more than one match found!");
                    } else {
                        match_found = true;
                        correct_id = icon_id;
                    }
                }
            });

            if (!(match_found)) {
                console.log("faulty set with no match found!");
            }

            DEBUG && console.log("correct icon:" + correct_id);
            if (document.was_correct || first_time) {
                // reset all objects
                $("#objects").html("");
                // sort the icons
                shuffleArray(controller_set.icons);

                // enable the pause button if master controller
                handle_pause_button();

                controller_set.icons.forEach(asset_id => {
                    if (asset_id == correct_id) {
                        correctClass = "correct";
                    } else {
                        correctClass = "";
                    }
                    $("#objects").attr("data-set-id", controller_set_id);
                    $("#objects").append('<div data-icon-id="' + asset_id + '"  class="object-container ' + correctClass + '"><img src="assets/asset' + asset_id + '.png"></div>');
                });

                $(".object-container").bind('touchstart mousedown click', function (event) {
                    // determine whether or not the clicked object is correct
                    correct = $(event.target).hasClass("correct") || $(event.target).parent().hasClass("correct");
                    DEBUG && console.log("guess is correct: " + correct);


                    $(".object-container").css("pointer-events", "none");
                    if (correct) {
                        air_console.vibrate(200);
                        document.was_correct = true;
                        // signal correctness to player by blinking
                        $("#correct").css('opacity', '1');
                        $("#correct").fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200);

                        // wait for the animations to finish
                        const correct_set_id = $("#objects").data("set-id");
                        // inform screen about correct guess
                        var command = [];
                        command.push({ type: "correct", set_id: correct_set_id });
                        air_console.message(0, command);
                    } else {
                        air_console.vibrate(200);
                        air_console.vibrate(200);
                        $("#wrong").css('opacity', '1');
                        $("#wrong").fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200);
                        $(event.target).css("opacity", "0.25");
                    }
                    sleep(1400).then(() => {
                        $(".object-container").css("pointer-events", "all");
                    });
                });
            } else {
                // only update the wrong/correct classes
                $(".object-container").removeClass("correct");
                jqueryString = '*[data-icon-id=' + correct_id + ']';
                console.log(jqueryString);
                $(jqueryString).addClass("correct");
            }
            document.was_correct = false;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
    <script type="module">
        import { objects, projective_sets } from './objects.js';

        document.projective_sets = projective_sets;

    </script>

</body>
<div id="score_and_objects_wrapper">
    <!-- <div id="score">
        <span class="score_span" id="correct_guesses">0 points</span>
        <span class="score_span" id="position">1st</span>
    </div> -->
    <div id="objects">

    </div>
    <div id="pause_button" class="button">
        PAUSE
    </div>
</div>
<div id="wrong">

</div>
<div id="correct">

</div>

<div id="slow">
    <p>
        Too slow!</br>
        <span id="round_winner">Player x</span>&nbsp;was faster than you.</br>
        A new round will begin shortly.
    </p>
</div>

<div id="fast">
    <p>
        You scored!</br>
        A new round will begin shortly.
    </p>
</div>

<div id="game_over">
    Game over!</br>
    Touch to go back to the main menu.
</div>

<div id="menu">
    <div class="button difficulty-option" id="rotation">
        Toggle Rotation
    </div>
    <div class="button difficulty-option" id="scaling">
        Toggle Scaling
    </div>
    <div class="button mainmenu-option difficulty-option" id="confirm">
        Start
    </div>
    <div class="button mainmenu-option" id="options">
        Options
    </div>
    <div class="button mainmenu-option" id="credits">
        Credits
    </div>
    <div class="button music-option" id="music">
        Toggle Music
    </div>
    <div class="button music-option" id="sfx">
        Toggle Sfx
    </div>
    <div class="button round-option" id="less">
        Less
    </div>
    <div class="button round-option" id="more">
        More
    </div>
    <div class="button music-option round-option" id="next">
        Next
    </div>
    <div class="button music-option round-option difficulty-option" id="back">
        Back
    </div>
    <div class="button pause-option" id="resume">
        Resume
    </div>
    <div class="button pause-option" id="quit">
        Quit
    </div>
    <div id="waiting_for_next_round">
        Please wait for the next round to begin.
    </div>
    <div id="waiting_for_start">
        Please wait for the master controller to start the game.
    </div>
    <div id="waiting_for_pause">
        Please wait for the master controller to resume or quit the game.
    </div>
</div>

</html>