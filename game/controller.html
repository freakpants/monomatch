<!DOCTYPE html>
<html>



<head>
    <script src="../phaser/dist/phaser.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Oswald|Roboto" rel="stylesheet">
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="controller.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }
    </style>
</head>

<body onload="init()">
    <script>

        var air_console;
        var DEBUG = true;

        $(document).ready(function () {
            $("#confirm").click(function (event) {

                // in case the button was the only button, resize it to normal size
                $("#confirm").css("width", "50vw");
                $("#confirm").css("height", "50vh");
                $("#confirm").css("position", "relative");

                $("#confirm").css("display", "flex");

                var command = [];
                command.push({ type: "confirm" });
                air_console.message(0, command);
            });
        });

        function am_i_master() {
            return (air_console.getMasterControllerDeviceId() !== undefined && air_console.getMasterControllerDeviceId() === air_console.getDeviceId());
        }

        function init() {
            air_console = new AirConsole();

            DEBUG && console.log("airconsole init");



            air_console.onMessage = function (from, data) {

                DEBUG && console.log("received messager on controller");
                if (data === undefined || data[0] === undefined || data[0].type === undefined) {
                    return;
                }
                switch (data[0].type) {
                    case "show_menu":
                    case "hide_menu":
                        if (am_i_master()) {
                            DEBUG && console.log("i am master");
                            $("#waiting_for_start").hide();
                            $("#confirm").css("display", "flex");
                        } else {
                            DEBUG && console.log("i am not master");
                            $("#waiting_for_start").css("display", "flex");
                            $("#confirm").hide();
                        }
                        break;
                    case "set":
                        DEBUG && console.log("received set info from screen");

                        // reset all objects
                        $("#objects").html("");

                        $("#menu").hide();
                        $("#waiting_for_start").hide();

                        // get our set
                        var controller_set = document.projective_sets.filter(obj => {
                            return obj.id === data[0].set_id;
                        })[0];
                        DEBUG && console.log(controller_set);
                        // get the set our screen has
                        var screen_set = document.projective_sets.filter(obj => {
                            return obj.id === data[0].screen_set_id;
                        })[0];
                        DEBUG && console.log(screen_set);

                        // determine which object is both on screen and on the controller
                        // compare our sets
                        match_found = false;
                        screen_set.icons.forEach(icon_id => {
                            if (controller_set.icons.includes(icon_id)) {
                                // check if this is the second match, which would mean we have a faulty set
                                if (match_found) {
                                    console.log("faulty set with more than one match found!");
                                } else {
                                    match_found = true;
                                    correct_id = icon_id;
                                }
                            }
                        });

                        if (!(match_found)) {
                            console.log("faulty set with no match found!");
                        }

                        DEBUG && console.log("correct icon:" + correct_id);

                        // sort the icons
                        shuffleArray(controller_set.icons);

                        controller_set.icons.forEach(asset_id => {
                            if (asset_id == correct_id) {
                                correctClass = "correct";
                            } else {
                                correctClass = "";
                            }
                            $("#objects").append('<div class="object-container ' + correctClass + '"><img src="assets/asset' + asset_id + '.png"></div>');
                        });

                        $(".object-container").click(function (event) {
                            // determine whether or not the clicked object is correct
                            correct = $(event.target).hasClass("correct") || $(event.target).parent().hasClass("correct");
                            DEBUG && console.log("guess is correct: " + correct);
                            if(correct){
                                // signal correctness to player by blinking
						        $("#correct").css('opacity', '1');
						        $("#correct").fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200);
                                
                                // wait for the animations to finish
                                sleep(1400).then(() => {
                                    // inform screen about correct guess
                                    var command = [];
                                    command.push({ type: "correct" });
                                    air_console.message(0, command);
                                });
                            } else {
						        $("#wrong").css('opacity', '1');
						        $("#wrong").fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200);
                                $(event.target).css("opacity", "0.25");
                            }
                        });
                        break;
                }
            }
        }

        function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
    <script type="module">
        import { objects, projective_sets } from '/game/objects.js';

        document.projective_sets = projective_sets;

    </script>

</body>
<div id="objects">

</div>
<div id="wrong">
        
</div>
<div id="correct">
        
</div>
<div id="menu">

    <!-- <div class="flexbox resizing-button" id="previous-button">
        <span class="fa-lg icon-container">
            <i class="fa fa-backward backward"></i>
        </span>
        <div class="button_text">Last</div>
    </div>
    <div class="flexbox resizing-button" id="next-button">
        <span class="fa-lg icon-container">
            <i class="fa fa-forward forward"></i>
        </span>
        <div class="button_text">Next</div>
    </div>
    <div id="round_change_buttons">
        <span class="fa-lg icon-container minus decrease_rounds">
            <i class="fa fa-minus minus"></i>
        </span>
        <span class="fa-lg icon-container plus increase_rounds">
            <i class="fa fa-plus plus"></i>
        </span>
    </div>
    <div class="flexbox resizing-button" id="cancel">
        <span class="fa-lg icon-container">
            <i class="fa fa-ban"></i>
        </span>
        <div class="button_text">Cancel/</br>Back</div>
    </div> -->
    <div class="flexbox resizing-button" id="confirm">
        <span class="fa-lg icon-container">
            <i class="fa fa-play play_icon"></i>
        </span>
        <div class="button_text">Start</div>
        <!-- <div class="button_comment">Play with current settings</div> -->
    </div>
    <div id="waiting_for_next_round">
        Please wait for the next round to begin.
    </div>



    <div id="waiting_for_start">
        Please wait for the master controller to start the game.
    </div>
    <!-- <div class="flexbox resizing-button" id="hero-confirm">
        <span class="fa-lg icon-container">
            <i class="fa fa-play play_icon"></i>
        </span>
        <div class="button_text">Select with Hero</div>
        <img id="small-hero-image"
            src="https://game.airconsole.com/com.airconsole.store.cdn.airconsole.com/2021-12-23-17-05-19/img/hero.45eeb9be.gif" />
    </div>
    <div class="flexbox resizing-button" id="hero-req">
        <img id="hero-image"
            src="https://game.airconsole.com/com.airconsole.store.cdn.airconsole.com/2021-12-23-17-05-19/img/hero.45eeb9be.gif" />
        <div class="button_text">Hero</br>required</div>
    </div>
-->
</div>

</html>